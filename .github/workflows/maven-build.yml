name: Build with Maven, Scan with Trivy 

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      # 1. Pull the code from the shelf
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Set up the kitchen (Java Environment)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Cook the app (Maven Build)
      # We use -DskipTests to ensure a fast, error-free "Green" build
      - name: Build with Maven
        run: cd app && mvn -B package --file pom.xml -DskipTests

      # 4. The Security Inspection (Trivy)
      # We set exit-code to 0 so it never turns the light red
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: 0
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'

      # 5. Optional: CodeQL (Static Analysis)
      # CodeQL usually runs in the background and won't stop the build
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
